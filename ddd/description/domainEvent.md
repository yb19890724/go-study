###### 领域事件 ：解耦微服务的关键

在事件风暴（Event Storming）时，我们发现除了命令和操作等业务行为以外，还有一种非常重要的事件，`这种事件发生后通常会导致进一步的业务操作，在 DDD 中这种事件被称为领域事件`。

###### 领域事件

领域中发生的事件。一个领域事件将导致进一步的业务操作，在实现业务解耦的同时，还有助于形成完整的业务闭环。

举例来说的话，领域事件可以是业务流程的一个步骤，比如下单业务付费完成后，触发仓库发货的动作；
也可能是定时批处理过程中发生的事件，比如批处理生成季缴保费通知单，触发发送缴费邮件通知操作；
或者一个事件发生后触发的后续动作，比如密码连续输错三次，触发锁定账户的动作。

###### 那如何识别领域事件呢？

> 在这些场景中，如果发生某种事件后，会触发进一步的操作，那么这个事件很可能就是领域事件。


##### 那领域事件为什么要用最终一致性，而不是传统 SOA 的直接调用的方式呢？

聚合的一个设计原则：`在边界之外使用最终一致性。一次事务最多只能更改一个聚合的状态`。如果一次业务操作涉及多个聚合状态的更改，应采用领域事件的最终一致性。

回到具体的业务场景，`我们发现有的领域事件发生在微服务内的聚合之间，有的则发生在微服务之间，还有两者皆有的场景，一般来说跨微服务的领域事件处理居多`。在微服务设计时不同领域事件的处理方式会不一样。


1. 微服务内的领域事件  

当领域事件发生在微服务内的聚合之间，领域事件发生后完成事件实体构建和事件数据持久化，发布方聚合将事件发布到事件总线，订阅方接收事件数据完成后续业务操作。

微服务内大部分事件的集成，都发生在同一个进程内，进程自身可以很好地控制事务，因此不一定需要引入消息中间件。
但一个事件如果同时更新多个聚合，按照 DDD`“一次事务只更新一个聚合”`的原则，你就要考虑是否引入`事件总线`。但微服务内的`事件总线`，可能会增加开发的复杂度，因此你需要结合应用复杂度和收益进行综合考虑。

微服务内应用服务，可以通过跨聚合的服务编排和组合，以服务调用的方式完成跨聚合的访问，这种方式通常应用于实时性和数据一致性要求高的场景。这个过程会用到分布式事务，以保证发布方和订阅方的数据同时更新成功。


2. 微服务之间的领域事件

跨微服务的领域事件会在不同的`限界上下文`或`领域模型`之间实现业务协作，其主要目的是实现`微服务解耦`，减轻微服务之间实时服务访问的压力。

领域事件发生在微服务之间的场景比较多，事件处理的机制也更加复杂。跨微服务的事件可以推动业务流程或者数据在不同的子域或微服务间直接流转。

跨微服务的事件机制要总体考虑`事件构建`、`发布和订阅`、`事件数据持久化`、`消息中间件`，甚至`事件数据持久化时还可能需要考虑引入分布式事务机制`等。


###### 实例

下单->支付->待发货->已发货->配送中->已完成

总之，通过领域事件驱动的异步化机制，可以推动业务流程和数据在各个不同微服务之间的流转，实现微服务的解耦，减轻微服务之间服务调用的压力，提升用户体验。


###### 领域事件总体架构

> `领域事件处理包括`：事件构建和发布、事件数据持久化、事件总线、消息中间件、事件接收和处理等。

1.事件构建和发布

(消息id)
事件基本属性至少包括：`事件唯一标识`、`发生时间`、`事件类型和事件源`，其中`事件唯一标识`应该是`全局唯一`的，以便事件能够无歧义地在多个`限界上下文中`传递。
事件基本属性主要记录事件自身以及事件发生背景的数据。


另外事件中还有一项更重要，那就是业务属性，用于记录事件发生那一刻的业务数据，这些数据会随`事件`传输到`订阅方`，以开展下一步的业务操作。

`事件基本属性`和`业务属性`一起构成`事件实体`，`事件实体`依赖`聚合根`。`领域事件`发生后，事件中的`业务数据`不再修改，因此业务数据可以以序列化值对象的形式保存，这种存储格式在消息中间件中也比较容易解析和获取。

事件发布之前需要先构建事件实体并持久化。事件发布的方式有很多种，你可以通过`应用服务`或者`领域服务`发布到`事件总线`或者`消息中间件`，也可以从`事件表`中利用定时程序或数据库日志捕获技术获取增量事件数据，发布到消息中间件。

2.事件数据持久化

事件数据持久化可用于系统之间的数据对账，或者实现发布方和订阅方事件数据的审计。当遇到消息中间件、订阅方系统宕机或者网络中断，在问题解决后仍可继续后续业务流转，保证数据的一致性。

方案:  
- 持久化到本地业务数据库的事件表中，利用本地事务保证业务和事件数据的一致性。
- 持久化到共享的事件数据库中。这里需要注意的是：`业务数据库`和`事件数据库`不在一个数据库中，它们的数据持久化操作会跨数据库，因此需要分布式事务机制来保证业务和事件数据的强一致性，结果就是会对系统性能造成一定的影响。


3.事件总线

`事件总线`是实现`微服务内聚合之间领域事件`的重要组件，它提供事件`分发`和`接收`等服务。事件总线是`进程内模型`，它会在`微服务内聚合之间`遍历订阅者列表，采取同步或异步的模式传递数据。事件分发流程大致如下：

- 如果是微服务内的订阅者（其它聚合），则直接分发到指定订阅者；
- 如果是微服务外的订阅者，将事件数据保存到事件库（表）并异步发送到消息中间件；
- 如果同时存在微服务内和外订阅者，则先分发到`内部订阅者`，将事件消息保存到事件库（表），再异步发送到消息中间件。

4.消息中间件
跨微服务的领域事件大多会用到消息中间件，实现跨微服务的事件发布和订阅。
消息中间件的产品非常成熟，市场上可选的技术也非常多，比如 Kafka，RabbitMQ 等。

5.事件接收和处理

微服务订阅方在应用层采用监听机制，接收消息队列中的事件数据，完成事件数据的持久化后，就可以开始进一步的业务处理。
领域事件处理可在`领域服务`中实现。


###### 领域事件运行机制相关案例


1. 投保微服务应用服务，调用聚合中的领域服务 createPaymentNotice 和 createPaymentNoticeEvent，分别创建缴费通知单、缴费通知单事件。其中缴费通知单事件类 PaymentNoticeEvent 继承基类 DomainEvent。

2. 利用仓储服务持久化缴费通知单相关的业务和事件数据。为了避免分布式事务，这些业务和事件数据都持久化到本地投保微服务数据库中。
3. 通过数据库日志捕获技术或者定时程序，从数据库事件表中获取事件增量数据，发布到消息中间件。这里说明：事件发布也可以通过应用服务或者领域服务完成发布。
4. 收款微服务在应用层从消息中间件订阅缴费通知单事件消息主题，监听并获取事件数据后，应用服务调用领域层的领域服务将事件数据持久化到本地数据库中。
5. 收款微服务调用领域层的领域服务 PayPremium，完成缴费。
6. 事件结束。

总结： 
今天我们主要讲了领域事件以及领域事件的处理机制。`领域事件驱动`是很成熟的技术，在很多分布式架构中得到了大量的使用。
领域事件是 DDD 的一个重要概念，在设计时我们要重点关注领域事件，用领域事件来驱动业务的流转，尽量采用基于事件的最终一致，降低微服务之间直接访问的压力，实现微服务之间的解耦，维护领域模型的独立性和数据一致性。
除此之外，领域事件驱动机制可以实现一个发布方 N 个订阅方的模式，这在传统的直接服务调用设计中基本是不可能做到的。